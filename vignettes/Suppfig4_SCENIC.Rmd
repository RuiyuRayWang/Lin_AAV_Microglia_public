---
title: "Supplementary Figure 4: Explore pySCENIC Results and Plots"
author: "Ruiyu Ray Wang"
date: "`r Sys.Date()`"
output: html_document
---

# Initialization

```{r}
rm(list = ls(all.names = TRUE))
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
# Output directories
pyScenicDir <- "../data/scenic_protocol"
```

```{r}
suppressPackageStartupMessages({
  library(SCENIC)
  library(SCopeLoomR)
  library(Seurat)
  library(SeuratDisk)
  library(tidyverse)
  library(ggplot2)
  library(ggpubr)
  library(RColorBrewer)
})
```

```{r}
suppressMessages(
  extrafont::loadfonts(device="postscript")
)
```

# Interactive session

Examine individual regulon activities interactively.

## Reference Dataset (10x)

### Reading the loom file
```{r}
pyScenicLoomFile <- file.path(pyScenicDir, "files", "AAV_MG_REF_scenic_integrated-output.loom")
loom <- open_loom(pyScenicLoomFile, mode="r")

## Read information from loom file:
# Regulons
regulons_incidMat <- get_regulons(loom, column.attr.name = "Regulons")
regulons_motif <- regulonsToGeneLists(regulons_incidMat)
regulons <- regulonsToGeneLists(regulons_incidMat)

# Regulon AUC and thresholds
regulonsAUC <- get_regulons_AUC(loom, column.attr.name = "RegulonsAUC")
thresholds <- get_regulon_thresholds(loom = loom)  ## This is buggy, make a hack.
regulonsAucThresholds <- names(thresholds)
names(regulonsAucThresholds) <- thresholds

# Embeddings
embeddings <- get_embeddings(loom)
```

```{r}
exprMat <- get_dgem(loom = loom)
cellInfo <- get_cell_annotation(loom = loom)
clusterings <- get_clusterings_with_name(loom = loom)
```

```{r}
close_loom(loom)
```

Manually explore and select binarization thresholds for AUCell scores, using shiny app.
```{r}
aucellApp <- AUCell_createViewerApp(auc = regulonsAUC,
                                    thresholds = regulonsAucThresholds,
                                    tSNE = embeddings$`Seurat UMAP  (highly variable genes)`,
                                    exprMat = exprMat)
savedSelections <- shiny::runApp(aucellApp)
saveRDS(savedSelections, '../data/scenic_protocol/reference_savedSelections.rds')  ## Optional
```

Parse AUC matrix.
```{r}
df_auc <- as.data.frame(t(regulonsAUC@assays@data$AUC)) %>%
  rownames_to_column("cells") %>%
  left_join(cellInfo %>% rownames_to_column("cells"), by = "cells") %>%
  column_to_rownames("cells")
df <- as.data.frame(embeddings$`Seurat UMAP  (highly variable genes)`) %>%
  rownames_to_column("cells") %>%
  left_join(df_auc %>% rownames_to_column("cells"), by = "cells") %>%
  column_to_rownames("cells")
```

### Generate Plots

#### Supplementary Figure 4a-b

Cebpb.
```{r}
df %>%
  ggplot(aes_string(x = "V1", y = "V2")) +
  geom_point(aes(fill = `Cebpb_(+)`), shape = 21, stroke = 0, size = 2.5) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +
  ggtitle("Cebpb_(+) Regulon Activity (Ref)") +
  xlab("UMAP_1") + ylab("UMAP_2") +
  theme_light() +
  theme(
    plot.title = element_text(size = 24),
    axis.title = element_text(size = 18),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.line = element_line(arrow = grid::arrow(length = unit(0.3, "cm"), 
                                                 ends = "last", type = "closed")),
    legend.position = c(.08, .005),
    legend.justification = c("left", "bottom"),
    legend.title = element_text(size = 18),
    legend.text = element_text(size = 16)
  )
ggsave(filename = "umap_ref_regulon_act_Cebpb.eps", 
       device = "eps", 
       path = "../outs/Figsupp4/",
       width = 6, height = 5, 
       family = "Arial")
```

```{r}
df_auc$treat <- factor(df_auc$treat, levels = c("Saline", "Poly(i:c)", "LPS"))
# cairo_ps(filename = 'outs/Figsupp4/hist_ref_regulon_act_Cebpb.eps', width = 4.8, height = 3.6)
# df_auc %>%
#   select(c(`Cebpb_(+)`,treat)) %>%
#   gghistogram(x = "Cebpb_(+)",
#               bins = 50,
#               xlab = "Cebpb_(+) Regulon Activity",
#               ylab = "Frequency") +
#   theme(
#     # axis.text.x = element_blank(),
#     # axis.title.x = element_blank(),
#     axis.text = element_text(size = 18, family = "Arial"),
#     axis.title = element_text(size = 22, family = "Arial")
#   )
# dev.off()

cairo_ps(filename = 'outs/Figsupp4/histfilled_ref_regulon_act_Cebpb.eps', width = 6, height = 4.5)
df_auc %>%
  select(c(`Cebpb_(+)`,treat)) %>%
  gghistogram(x = "Cebpb_(+)",
              bins = 50,
              fill = "treat",
              palette = brewer.pal(n = 12, name = "Paired")[c(1,3,5)],
              xlab = "Cebpb_(+) Regulon Activity",
              ylab = "Frequency",
              legend = "none",
              legend.title = "Treatment",
              rug = TRUE) +
  theme(
    axis.text = element_text(size = 18, family = "Arial"),
    axis.title = element_text(size = 22, family = "Arial"),
  )
dev.off()
```

## Query Dataset (Smart-seq2)

### Reading the loom filet
```{r}
pyScenicLoomFile <- file.path(pyScenicDir, "files", "AAV_MG_QUERY_TRANSF_scenic_integrated-output.loom")
loom <- open_loom(pyScenicLoomFile, mode="r")

## Read information from loom file:
# Regulons
regulons_incidMat <- get_regulons(loom, column.attr.name = "Regulons")
regulons_motif <- regulonsToGeneLists(regulons_incidMat)
regulons <- regulonsToGeneLists(regulons_incidMat)

# Regulon AUC and thresholds
regulonsAUC <- get_regulons_AUC(loom, column.attr.name = "RegulonsAUC")
thresholds <- get_regulon_thresholds(loom = loom)  ## This is buggy, make a hack.
regulonsAucThresholds <- names(thresholds)
names(regulonsAucThresholds) <- thresholds

# Embeddings
embeddings <- get_embeddings(loom)
```

```{r}
exprMat <- get_dgem(loom = loom)
cellInfo <- get_cell_annotation(loom = loom)
clusterings <- get_clusterings_with_name(loom = loom)
```

```{r}
close_loom(loom)
```

Manually explore and select binarization thresholds for AUCell scores, using shiny app.
```{r}
aucellApp <- AUCell_createViewerApp(auc = regulonsAUC,
                                    thresholds = regulonsAucThresholds,
                                    tSNE = embeddings$`Seurat UMAP  (highly variable genes)`,
                                    exprMat = exprMat)
savedSelections <- shiny::runApp(aucellApp)
saveRDS(savedSelections, '../data/scenic_protocol/query_savedSelections.rds')  ## Optional
```

Parse AUC matrix.
```{r}
df_auc <- as.data.frame(t(regulonsAUC@assays@data$AUC)) %>%
  rownames_to_column("cells") %>%
  left_join(cellInfo %>% rownames_to_column("cells"), by = "cells") %>%
  column_to_rownames("cells")
df <- as.data.frame(embeddings$`Seurat UMAP  (highly variable genes)`) %>%
  rownames_to_column("cells") %>%
  left_join(df_auc %>% rownames_to_column("cells"), by = "cells") %>%
  column_to_rownames("cells")
```

### Generate Plots

#### Supplementary Figure 4c-d

Cebpb.
```{r}
df %>%
  ggplot(aes_string(x = "V1", y = "V2")) +
  geom_point(aes(fill = `Cebpb_(+)`), shape = 21, stroke = 0, size = 2.5) +
  scale_fill_distiller(palette = "PuRd", direction = 1) +
  ggtitle("Cebpb_(+) Regulon Activity (Query)") +
  xlab("UMAP_1") + ylab("UMAP_2") +
  theme_light() +
  theme(
    plot.title = element_text(size = 24),
    axis.title = element_text(size = 18),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.line = element_line(arrow = grid::arrow(length = unit(0.3, "cm"), 
                                                 ends = "last", type = "closed")),
    legend.position = c(.75, .02),
    legend.justification = c("left", "bottom"),
    legend.title = element_text(size = 18),
    legend.text = element_text(size = 16)
  )
ggsave(filename = "umap_query_regulon_act_Cebpb.eps", 
       device = "eps", 
       path = "../outs/Figsupp4/",
       width = 6, height = 5, 
       family = "Arial")
```

```{r}
df_auc$ident <- factor(df_auc$ident, levels = c("Non-transduced", "Transduced", "LPS(Query)"))
# cairo_ps(filename = 'outs/Figsupp4/hist_query_regulon_act_Cebpb.eps', width = 4, height = 3)
# df_auc %>%
#   select(c(`Cebpb_(+)`)) %>%
#   gghistogram(x = "Cebpb_(+)",
#               bins = 25,
#               xlab = "Cebpb_(+) Regulon Activity",
#               ylab = "Frequency") +
#   theme(
#     axis.text.x = element_blank(),
#     axis.title.x = element_blank(),
#     axis.text.y = element_text(size = 16, family = "Arial"),
#     axis.title.y = element_text(size = 20, family = "Arial")
#   )
# dev.off()

cairo_ps(filename = 'outs/Figsupp4/histfilled_query_regulon_act_Cebpb.eps', width = 6, height = 4.5)
df_auc %>%
  select(c(`Cebpb_(+)`,ident)) %>%
  gghistogram(x = "Cebpb_(+)",
              bins = 25,
              fill = "ident",
              palette = brewer.pal(n = 12, name = "Paired")[c(2,7,6)],
              xlab = "Cebpb_(+) Regulon Activity",
              ylab = "Frequency",
              legend = "none",
              legend.title = "Treatment",
              rug = TRUE) +
  theme(
    axis.title = element_text(size = 22, family = "Arial"),
    axis.text = element_text(size = 18, family = "Arial")
  )
dev.off()
```

```{r}
sessionInfo()
```

