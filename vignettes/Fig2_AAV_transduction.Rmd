---
title: "Main Figure: Label Transfer"
author: "Ruiyu Ray Wang"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls(all.names = TRUE))
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Initialization

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(SeuratDisk)
  library(tidyverse)
  library(ggplot2)
  library(patchwork)
  library(RColorBrewer)
})
```

```{r}
suppressMessages(
  extrafont::loadfonts(device="postscript")
)
```

```{r}
querydata <- LoadH5Seurat('../data/AAV_MG_scRNAseq/cells_query.h5Seurat')
query_transferred <- LoadH5Seurat('../data/AAV_MG_scRNAseq/cells_query_transferred.h5Seurat')
refdata <- LoadH5Seurat('../data/AAV_MG_scRNAseq/refdata_clean.h5Seurat')
refquery <- LoadH5Seurat('../data/AAV_MG_scRNAseq/refquery.h5Seurat')
```

# Making Plots

## Figure 2a

Schematics showing workflow of scRNAseq experiments and label transfer analysis.

```{r}
# Idents(querydata) <- "seurat_clusters"  ## RNA_snn_res.0.2
DimPlot(querydata, pt.size = 3, group.by = "group", cols = brewer.pal(n = 12, name = "Paired")[c(7,6)]) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank()
  )
ggsave(device = "eps", 
       path = "../outs/Fig2a/", 
       filename = "schematics_querydata.eps", 
       width = 4, height = 3.6)
```

```{r}
DimPlot(refdata, group.by = "treat", pt.size = 2, shuffle = TRUE) +
  scale_color_manual(values = brewer.pal(n = 12, name = "Paired")[c(1,3,5)])+
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank()
  )
ggsave(device = "eps", 
       path = "../outs/Fig2a/", 
       filename = "schematics_refdata.eps", 
       width = 5, height = 4)
```

## Figure 2b

Descriptive analysis of the Query Dataset (Smart-seq2). Discrimination of "Transduced" and "Non-transduced" cells are based on whether *mScarlet* transcripts are expressed in the cells (cells is "Transduced" if mScarlet > 0).

```{r}
DimPlot(querydata, group.by = "transduce_serotype", pt.size = 2, 
        cols = c(brewer.pal(n = 12, name = "Paired")[c(6,12,8)],"#CCCCCC")) +
  NoAxes() +
  theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank()
  )
ggsave(device = "eps", 
       path = "../outs/Fig2b/", 
       filename = "umap_query.eps", 
       width = 4, height = 3.6)
```

## Figure 2c

```{r}
queryaav_sub <- subset(querydata, subset = group == "AAV")
queryaav_sub <- queryaav_sub %>%
  NormalizeData() %>%
  FindVariableFeatures() %>%
  ScaleData() %>%
  RunPCA() %>%
  FindNeighbors(dims = 1:20) %>%
  FindClusters(resolution = 0.3) %>%
  RunUMAP(dims = 1:20)
```
```{r}
DimPlot(queryaav_sub, group.by = "transduce_serotype", pt.size = 3.6, 
        cols = c(brewer.pal(12, "Paired")[c(12,8)],"#CCCCCC")) +
  NoAxes() +
  theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank()
  )
# as.data.frame(Embeddings(queryaav_sub[["umap"]])) %>% 
#   mutate(transduce_serotype = queryaav_sub$transduce_serotype,
#                 transduction = queryaav_sub$transduction) %>%
#   ggplot(mapping = aes(x = UMAP_1, y = UMAP_2, fill = transduction, shape = transduce_serotype)) +
#   geom_point(size = 2, stroke = 0) +
#   scale_fill_manual(values = brewer.pal(n = 8, name = "Set1")[c(2,5)]) +
#   scale_shape_manual(values = c("Non-transduced" = 21, "AAV-MG1.1" = 22, "AAV-MG1.2" = 23)) +
#   theme(
#     legend.position = "none",
#     panel.background = element_blank(),
#     panel.border = element_blank(),
#     axis.title = element_blank(),
#     axis.ticks = element_blank(),
#     axis.text = element_blank(),
#     legend.key = element_blank()
#     )  ## Does not look very well
ggsave(filename = "umap_query_aavsub.eps", 
       path = "../outs/Fig2c/", 
       device = "eps", 
       width = 6, height = 5)
```

## Figure 2d

```{r}
## Order by factor
querydata$transduce_serotype <- factor(querydata$transduce_serotype, 
                                       levels = c("LPS","AAV-MG1.1","AAV-MG1.2","Non-transduced"))
umap_lps <- as.data.frame(Embeddings(querydata[["umap"]])) %>% 
  mutate(transduce_serotype = querydata$transduce_serotype) %>%
  ggplot(mapping = aes(x = UMAP_1, y = UMAP_2, color = transduce_serotype)) +
  geom_point(aes(size = transduce_serotype), position = "jitter") +
  scale_size_manual(values = c(2,0.8,0.8,0.8)) +
  scale_color_manual(values = c(brewer.pal(12, "Paired")[c(6,11,7)],"#CCCCCC")) +
  theme(
    legend.position = "none",
    panel.background = element_blank(),
    panel.border = element_rect(color = "gray", size = 1, fill = NA),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    legend.key = element_blank()
    )

queryaav_sub$transduce_serotype <- factor(queryaav_sub$transduce_serotype,
                                          levels = c("AAV-MG1.1","AAV-MG1.2","Non-transduced"))
umap_mg1.1 <- as.data.frame(Embeddings(queryaav_sub[["umap"]])) %>% 
  mutate(transduce_serotype = queryaav_sub$transduce_serotype) %>%
  ggplot(mapping = aes(x = UMAP_1, y = UMAP_2, color = transduce_serotype)) +
  geom_point(aes(size = transduce_serotype), position = "jitter") +
  scale_size_manual(values = c(2,0.8,0.8)) +
  scale_color_manual(values = c(brewer.pal(12, "Paired")[c(12,7)],"#CCCCCC")) +
  theme(
    legend.position = "none",
    panel.background = element_blank(),
    panel.border = element_rect(color = "gray", size = 1, fill = NA),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    legend.key = element_blank()
    )

umap_mg1.2 <- as.data.frame(Embeddings(queryaav_sub[["umap"]])) %>% 
  mutate(transduce_serotype = queryaav_sub$transduce_serotype) %>%
  ggplot(mapping = aes(x = UMAP_1, y = UMAP_2, color = transduce_serotype)) +
  geom_point(aes(size = transduce_serotype), position = "jitter") +
  scale_size_manual(values = c(0.8,2,0.8)) +
  scale_color_manual(values = c(brewer.pal(12, "Paired")[c(11,8)],"#CCCCCC")) +
  theme(
    legend.position = "none",
    panel.background = element_blank(),
    panel.border = element_rect(color = "gray", size = 1, fill = NA),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    legend.key = element_blank()
    )

umap_non_transduced <- as.data.frame(Embeddings(queryaav_sub[["umap"]])) %>% 
  mutate(transduce_serotype = queryaav_sub$transduce_serotype) %>%
  ggplot(mapping = aes(x = UMAP_1, y = UMAP_2, color = transduce_serotype)) +
  geom_point(aes(size = transduce_serotype), position = "jitter") +
  scale_size_manual(values = c(0.8,0.8,2)) +
  scale_color_manual(values = c(brewer.pal(12, "Paired")[c(11,7)],"#999999")) +
  theme(
    legend.position = "none",
    panel.background = element_blank(),
    panel.border = element_rect(color = "gray", size = 1, fill = NA),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    legend.key = element_blank()
    )

querydata$transduce_serotype <- factor(querydata$transduce_serotype, 
                                       levels = c("Non-transduced","AAV-MG1.2","AAV-MG1.1","LPS"))
violin_mScarlet <- VlnPlot(querydata, 
                           features = "mScarlet_norm", 
                           group.by = "transduce_serotype", 
                           cols = c("#CCCCCC",brewer.pal(12, "Paired")[c(7,11,5)]),
                           pt.size = 1.6) + 
  coord_flip() + 
  NoLegend() +
  ggtitle(NULL) +
  ylab("mScarlet Expression") +
  theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 18)
  )

((umap_lps / umap_mg1.1 / umap_mg1.2 / umap_non_transduced) | violin_mScarlet) + plot_layout(widths = c(0.9,1.6))

ggsave(filename = "query_violin.eps", 
       device = "eps", 
       path = "../outs/Fig2d/", 
       width = 6, height = 7.2, 
       family = "Arial")
```

## Figure 2e

UMAP colored by Louvain clusters.

```{r}
DimPlot(queryaav_sub, group.by = "seurat_clusters", pt.size = 2) + 
  NoAxes() + 
  NoLegend() + 
  theme_minimal() +
  ggtitle(NULL) +
  theme(
    panel.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    legend.position = "none"
  )
ggsave(filename = "umap_queryaav_louvain.eps", 
       device = "eps", 
       path = "../outs/Fig2e/", 
       width = 4, height = 3, 
       family = "Arial")

DimPlot(queryaav_sub, group.by = "transduction", 
        cols = brewer.pal(n = 12, name = "Paired")[c(8,2)],
        pt.size = 2) + 
  NoAxes() + 
  NoLegend() + 
  theme_minimal() +
  ggtitle(NULL) +
  theme(
    panel.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    legend.position = "none"
  )
ggsave(filename = "umap_queryaav_transduction.eps", 
       device = "eps", 
       path = "../outs/Fig2e/", 
       width = 4, height = 3, 
       family = "Arial")
```

## Figure 2f

```{r}
df <- queryaav_sub[[c("transduction","seurat_clusters")]]
df <- dplyr::rename(df, "Louvain clusters" = "seurat_clusters")

basic_table <- table(df)

# epitools::oddsratio(mg_table, method = "wald")
epitools::oddsratio(basic_table, method = "wald")$measure[-1,]
epitools::oddsratio(basic_table, method = "wald")$p.value

## cvms::plot_confusion_matrix() use integer levels
df$transduction <- dplyr::recode(df$transduction, "Transduced" = 1, "Non-transduced" = 0)

basic_table <- table(df)
cfm <- as_tibble(basic_table)

g <- cvms::plot_confusion_matrix(cfm, 
                                 target_col = "Louvain clusters",
                                 prediction_col = "transduction",
                                 counts_col = "n",
                                 add_arrows = FALSE)
g + 
  xlab("Louvain clusters") +
  ylab("Transduction") +
  scale_x_discrete(labels = c("C1","C2"), position = "top") +
  scale_y_discrete(labels = c("Non-transduced","Transduced")) +
  theme(
    text = element_text(size = 18)
  )

ggsave(filename = "cfm.eps", 
       device = "eps", 
       path = "../outs/Fig2f/", 
       width = 4, height = 3.6, 
       family = "Arial")
```

## Figure 2g

Joint visualization by 'De novo' Recomputed UMAP of Query and Reference Datasets:

```{r}
as.data.frame(Embeddings(refquery[["umap"]])) %>%
  mutate(id = refquery$id, ident = refquery$ident) %>%
  ggplot(mapping = aes(x = UMAP_1, y = UMAP_2, color = ident, group = id)) +
  geom_point(aes(shape = id), size = 1.5) +
  scale_color_manual(values = brewer.pal(n = 12, name = "Paired")[c(6,8,2,1,3,5)]) +
  scale_shape_manual(values = c(23,20)) +
  theme_minimal() +
  theme(
    panel.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    legend.position = "none"
    )
ggsave(filename = "de_novo_umap_refquery.eps", 
       device = "eps", 
       path = "../outs/Fig2g/", 
       width = 5, height = 4, 
       family = "Arial")
as.data.frame(Embeddings(refquery[["umap"]])) %>%
  mutate(id = refquery$id, ident = refquery$ident) %>%
  ggplot(mapping = aes(x = UMAP_1, y = UMAP_2, color = ident, group = id)) +
  geom_point(aes(shape = id), size = 1.5) +
  scale_color_manual(values = brewer.pal(n = 12, name = "Paired")[c(6,8,2,1,3,5)]) +
  scale_shape_manual(values = c(23,20)) +
  # theme_minimal() +
  theme(
    panel.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    legend.position = "none"
    )
ggsave(filename = "de_novo_umap_refquery_crop.eps", 
       device = "eps", 
       path = "../outs/Fig2g/", 
       width = 5, height = 4, 
       family = "Arial")
```

## Figure 2h

```{r}
query_transferred[[c("predicted.state","ident")]] %>%
  ggplot(mapping = aes(predicted.state)) +
  geom_bar(aes(fill = ident), width = 0.5) +
  scale_x_discrete(labels = c("Homeostatic" = "Saline", "Reactive" = "LPS")) +
  scale_y_continuous(expand = c(0,0), limits = c(0,390)) +
  ylab("Number of cells") +
  xlab("Predicted state") +
  scale_fill_manual(values = brewer.pal(n = 12, name = "Paired")[c(6,2,8)]) +
  theme_classic() +
  theme(
    legend.position = "none",
    axis.title = element_text(size = 18),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 13),
  )
ggsave(filename = "barplot_numcells_predicted.eps", 
       device = "eps", 
       path = '../outs/Fig2h',
       width = 3, height = 4,
       family = "Arial")
```

