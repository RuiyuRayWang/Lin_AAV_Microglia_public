---
title: "Lin et al.: AAV Microglia"
subtitle: "Figure 2"
author: "Ruiyu Ray Wang"
date: "`r Sys.Date()`"
output: html_document
---

```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## About this vignette

This vignette aims to reproduces Figure 2 in the original publication (Lin et al., 2022).

Here we only show how plain plots were generated directly from data. To reach the final illustrations in the publication, these plots requires further editing in graphic design softwares (i.e. Adobe Illustrator). Those beautification steps are not central to our analysis and therefore will be omitted.

## TL;DR

You may click on the following links to fast forward to the codes directly producing the Figures:

  - [Figure 2a](#Figure2a)
  - [Figure 2b](#Figure2b)
  - [Figure 2c](#Figure2c)
  - [Figure 2d](#Figure2d)
  - [Figure 2e](#Figure2e)
  - [Figure 2f](#Figure2f)
  - [Figure 2g](#Figure2g)
  - [Figure 2h](#Figure2h)

## Initialization

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(SeuratDisk)
  library(tidyverse)
  library(ggplot2)
  library(patchwork)
  library(RColorBrewer)
  library(cvms)
  library(epitools)
})
```

```{r}
querydata <- LoadH5Seurat('../data/AAV_MG_scRNAseq/query_clean.h5Seurat', verbose = F)
query_transferred <- LoadH5Seurat('../data/AAV_MG_scRNAseq/query_transferred.h5Seurat', verbose = F)
refdata <- LoadH5Seurat('../data/AAV_MG_scRNAseq/refdata_clean.h5Seurat', verbose = F)
refquery <- LoadH5Seurat('../data/AAV_MG_scRNAseq/refquery.h5Seurat', verbose = F)
```

## Making Plots

### Figure 2a {#Figure2a}

Schematics showing workflow of scRNAseq experiments and label transfer analysis.

Query Dataset.
```{r}
DimPlot(querydata, pt.size = 3, group.by = "group", cols = brewer.pal(n = 12, name = "Paired")[c(7,6)]) +
  ggtitle(NULL) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank()
  )
```

Reference Dataset.
```{r}
DimPlot(refdata, group.by = "treat", pt.size = 2, shuffle = TRUE) +
  scale_color_manual(values = brewer.pal(n = 12, name = "Paired")[c(5,3,1)])+
  theme_minimal() +
  ggtitle(NULL) +
  theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank()
  )
```

### Figure 2b-d

Descriptive analysis of the Query Dataset (Smart-seq2). Discrimination of "Transduced" and "Untransduced" cells are based on whether *mScarlet* transcripts are expressed in the cells (cells is "Transduced" if mScarlet > 0).

### Figure 2b {#Figure2b}

```{r}
DimPlot(querydata, group.by = "transduce_serotype", pt.size = 2, 
        cols = c(brewer.pal(n = 12, name = "Paired")[c(6,12,8)],"#CCCCCC")) +
  NoAxes() +
  ggtitle(NULL) +
  theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank()
  )
```

### Figure 2c {#Figure2c}

```{r}
queryaav_sub <- subset(querydata, subset = group == "AAV")
queryaav_sub <- queryaav_sub %>%
  NormalizeData() %>%
  FindVariableFeatures() %>%
  ScaleData() %>%
  RunPCA() %>%
  FindNeighbors(dims = 1:20) %>%
  FindClusters(resolution = 0.3) %>%
  RunUMAP(dims = 1:20)
```
```{r fig.width=5, fig.height=3.6}
DimPlot(queryaav_sub, group.by = "transduce_serotype", pt.size = 3.6, 
        cols = c(brewer.pal(12, "Paired")[c(12,8)],"#CCCCCC")) +
  NoAxes() +
  ggtitle(NULL) +
  theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank()
  )
```

### Figure 2d {#Figure2d}

```{r}
## Order by factor
querydata$transduce_serotype <- factor(querydata$transduce_serotype, 
                                       levels = c("LPS","AAV-MG1.1","AAV-MG1.2","Untransduced"))
umap_lps <- as.data.frame(Embeddings(querydata[["umap"]])) %>% 
  mutate(transduce_serotype = querydata$transduce_serotype) %>%
  ggplot(mapping = aes(x = UMAP_1, y = UMAP_2, color = transduce_serotype)) +
  geom_point(aes(size = transduce_serotype), position = "jitter") +
  scale_size_manual(values = c(2,0.8,0.8,0.8)) +
  scale_color_manual(values = c(brewer.pal(12, "Paired")[c(6,11,7)],"#CCCCCC")) +
  theme(
    legend.position = "none",
    panel.background = element_blank(),
    panel.border = element_rect(color = "gray", size = 1, fill = NA),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    legend.key = element_blank()
    )

queryaav_sub$transduce_serotype <- factor(queryaav_sub$transduce_serotype,
                                          levels = c("AAV-MG1.1","AAV-MG1.2","Untransduced"))
umap_mg1.1 <- as.data.frame(Embeddings(queryaav_sub[["umap"]])) %>% 
  mutate(transduce_serotype = queryaav_sub$transduce_serotype) %>%
  ggplot(mapping = aes(x = UMAP_1, y = UMAP_2, color = transduce_serotype)) +
  geom_point(aes(size = transduce_serotype), position = "jitter") +
  scale_size_manual(values = c(2,0.8,0.8)) +
  scale_color_manual(values = c(brewer.pal(12, "Paired")[c(12,7)],"#CCCCCC")) +
  theme(
    legend.position = "none",
    panel.background = element_blank(),
    panel.border = element_rect(color = "gray", size = 1, fill = NA),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    legend.key = element_blank()
    )

umap_mg1.2 <- as.data.frame(Embeddings(queryaav_sub[["umap"]])) %>% 
  mutate(transduce_serotype = queryaav_sub$transduce_serotype) %>%
  ggplot(mapping = aes(x = UMAP_1, y = UMAP_2, color = transduce_serotype)) +
  geom_point(aes(size = transduce_serotype), position = "jitter") +
  scale_size_manual(values = c(0.8,2,0.8)) +
  scale_color_manual(values = c(brewer.pal(12, "Paired")[c(11,8)],"#CCCCCC")) +
  theme(
    legend.position = "none",
    panel.background = element_blank(),
    panel.border = element_rect(color = "gray", size = 1, fill = NA),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    legend.key = element_blank()
    )

umap_non_transduced <- as.data.frame(Embeddings(queryaav_sub[["umap"]])) %>% 
  mutate(transduce_serotype = queryaav_sub$transduce_serotype) %>%
  ggplot(mapping = aes(x = UMAP_1, y = UMAP_2, color = transduce_serotype)) +
  geom_point(aes(size = transduce_serotype), position = "jitter") +
  scale_size_manual(values = c(0.8,0.8,2)) +
  scale_color_manual(values = c(brewer.pal(12, "Paired")[c(11,7)],"#999999")) +
  theme(
    legend.position = "none",
    panel.background = element_blank(),
    panel.border = element_rect(color = "gray", size = 1, fill = NA),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    legend.key = element_blank()
    )

querydata$transduce_serotype <- factor(querydata$transduce_serotype, 
                                       levels = c("Untransduced","AAV-MG1.2","AAV-MG1.1","LPS"))
violin_mScarlet <- VlnPlot(querydata, 
                           features = "mScarlet_norm", 
                           group.by = "transduce_serotype", 
                           cols = c("#CCCCCC",brewer.pal(12, "Paired")[c(7,11,5)]),
                           pt.size = 1.6) + 
  coord_flip() + 
  NoLegend() +
  ggtitle(NULL) +
  ylab("mScarlet Expression") +
  theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 18)
  )
```
```{r fig.width=5, fig.height=6}
((umap_lps / umap_mg1.1 / umap_mg1.2 / umap_non_transduced) | violin_mScarlet) + plot_layout(widths = c(0.9,1.6))
```

### Figure 2e {#Figure2e}

UMAP colored by Transduction.
```{r fig.width=4, fig.height=3.4}
DimPlot(queryaav_sub, group.by = "transduction", 
        cols = brewer.pal(n = 12, name = "Paired")[c(8,2)],
        pt.size = 2) + 
  NoAxes() + 
  NoLegend() + 
  theme_minimal() +
  ggtitle(NULL) +
  theme(
    panel.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    legend.position = "bottom"
  )
```

UMAP colored by Louvain clusters.
```{r fig.width=4, fig.height=3.4}
Idents(queryaav_sub) <- "seurat_clusters"
queryaav_sub <- RenameIdents(queryaav_sub, `0` = "C1", `1` = "C2")
DimPlot(queryaav_sub, pt.size = 2) + 
  NoAxes() + 
  NoLegend() + 
  theme_minimal() +
  ggtitle(NULL) +
  theme(
    panel.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    legend.position = "bottom"
  )
```

### Figure 2f {#Figure2f}

```{r}
df <- queryaav_sub[[c("transduction","seurat_clusters")]]
df <- dplyr::rename(df, "Louvain clusters" = "seurat_clusters")

basic_table <- table(df)

epitools::oddsratio(basic_table, method = "wald")$measure[-1,]
epitools::oddsratio(basic_table, method = "wald")$p.value

## cvms::plot_confusion_matrix() use integer levels
df$transduction <- dplyr::recode(df$transduction, "Transduced" = 1, "Untransduced" = 0)

basic_table <- table(df)
cfm <- as_tibble(basic_table)

g <- cvms::plot_confusion_matrix(cfm, 
                                 target_col = "Louvain clusters",
                                 prediction_col = "transduction",
                                 counts_col = "n",
                                 add_arrows = FALSE)
g + 
  xlab("Louvain clusters") +
  ylab("Transduction") +
  scale_x_discrete(labels = c("C1","C2"), position = "top") +
  scale_y_discrete(labels = c("Untransduced","Transduced")) +
  theme(
    text = element_text(size = 18)
  )

```

### Figure 2g {#Figure2g}

Joint visualization by 'De novo' Recomputed UMAP of Query and Reference Datasets.  
In the publication, this plot is rotated 180 degrees to provide better visualization.
```{r}
as.data.frame(Embeddings(refquery[["umap"]])) %>%
  mutate(id = refquery$id, ident = refquery$ident) %>%
  ggplot(mapping = aes(x = UMAP_1, y = UMAP_2, color = ident, group = id)) +
  geom_point(aes(shape = id), size = 1.5) +
  scale_color_manual(values = brewer.pal(n = 12, name = "Paired")[c(6,8,2,1,3,5)]) +
  scale_shape_manual(values = c(23,20)) +
  theme_minimal() +
  theme(
    panel.background = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    legend.position = "none"
    )
```

### Figure 2h {#Figure2h}

```{r}
query_transferred[[c("predicted.state","ident")]] %>%
  ggplot(mapping = aes(predicted.state)) +
  geom_bar(aes(fill = ident), width = 0.5) +
  scale_x_discrete(labels = c("Homeostatic" = "Saline", "Reactive" = "LPS")) +
  scale_y_continuous(expand = c(0,0), limits = c(0,390)) +
  ylab("Number of cells") +
  xlab("Predicted state") +
  scale_fill_manual(values = brewer.pal(n = 12, name = "Paired")[c(6,2,8)]) +
  theme_classic() +
  theme(
    legend.position = "right",
    axis.title = element_text(size = 18),
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 13),
  )
```

## Session info

```{r}
sessionInfo()
```
